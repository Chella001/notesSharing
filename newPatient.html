<script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
        apiKey: "AIzaSyCMmDlzMavatvqE9-gKW4V6nPAV4U5CzDo",
        authDomain: "notessharingapp-fc388.firebaseapp.com",
        projectId: "notessharingapp-fc388",
        storageBucket: "notessharingapp-fc388.firebasestorage.app",
        messagingSenderId: "64602136432",
        appId: "1:64602136432:web:6e32abecc2bc9ec98179b5"
    };

    // ==================== INITIALIZE FIREBASE ====================
    let db;
    let auth;
    
    try {
        // Check if Firebase is already initialized
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log("‚úÖ Firebase initialized successfully");
        } else {
            console.log("‚úÖ Firebase already initialized");
        }
        
        db = firebase.firestore();
        auth = firebase.auth();
        
        // Enable offline persistence for better performance
        db.enablePersistence()
            .catch(err => {
                if (err.code === 'failed-precondition') {
                    console.log("Persistence failed - multiple tabs open");
                } else if (err.code === 'unimplemented') {
                    console.log("Persistence not supported");
                }
            });
            
    } catch (error) {
        console.error("‚ùå Firebase initialization error:", error);
        showNotification("Firebase configuration error: " + error.message, "error");
    }

    // ==================== HELPER FUNCTIONS ====================
    function showNotification(message, type = "success") {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.background = type === "success" ? "#1e4b6e" : "#b34040";
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function formatDate(date) {
        if (!date) return 'N/A';
        if (date.toDate) {
            const d = date.toDate();
            return d.toLocaleDateString('en-GB');
        }
        return date;
    }

    function formatTime(date) {
        if (!date) return 'N/A';
        if (date.toDate) {
            const d = date.toDate();
            return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        return '--:--';
    }

    // Set current date
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });

    // ==================== LOAD DASHBOARD DATA ====================
    async function loadDashboardData() {
        try {
            // Check if we came from new patient, doctor, or appointment page
            const urlParams = new URLSearchParams(window.location.search);
            
            // Show appropriate notification
            if (urlParams.get('newPatient') === 'success') {
                showNotification("‚úÖ New patient added successfully! Count updated.", "success");
                // Remove the parameter from URL without reloading
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (urlParams.get('newDoctor') === 'success') {
                showNotification("‚úÖ New doctor added successfully! Count updated.", "success");
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (urlParams.get('newAppointment') === 'success') {
                showNotification("‚úÖ New appointment scheduled successfully! Count updated.", "success");
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                showNotification("Loading dashboard data...", "success");
            }
            
            // Load Patients Count
            const patientsSnapshot = await db.collection('patients').get();
            const totalPatients = patientsSnapshot.size;
            document.getElementById('totalPatients').textContent = totalPatients;
            console.log("Total patients:", totalPatients);

            // Load Doctors Count
            const doctorsSnapshot = await db.collection('doctors').get();
            const totalDoctors = doctorsSnapshot.size;
            document.getElementById('totalDoctors').textContent = totalDoctors;
            console.log("Total doctors:", totalDoctors);

            // Load Appointments Count
            const appointmentsSnapshot = await db.collection('appointments').get();
            const totalAppointments = appointmentsSnapshot.size;
            document.getElementById('totalAppointments').textContent = totalAppointments;
            console.log("Total appointments:", totalAppointments);

            // Calculate Revenue
            let totalRevenue = 0;
            appointmentsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.status === 'Completed' && data.fee) {
                    totalRevenue += data.fee;
                }
            });
            document.getElementById('totalRevenue').textContent = `‚Çπ${totalRevenue.toLocaleString()}`;

            // Load Recent Appointments (last 5)
            const recentAppointmentsQuery = await db.collection('appointments')
                .orderBy('date', 'desc')
                .limit(5)
                .get();
            
            // Display Appointments
            const appointmentsBody = document.getElementById('appointmentsBody');
            appointmentsBody.innerHTML = '';

            if (recentAppointmentsQuery.empty) {
                appointmentsBody.innerHTML = '<tr><td colspan="6" class="no-data">üì≠ No appointments found. Click "Add Sample Data" to get started.</td></tr>';
            } else {
                recentAppointmentsQuery.forEach(doc => {
                    const apt = doc.data();
                    const row = document.createElement('tr');
                    
                    // Format date properly
                    let dateStr = 'N/A';
                    if (apt.date) {
                        if (apt.date.toDate) {
                            dateStr = apt.date.toDate().toLocaleDateString('en-GB');
                        } else if (apt.date instanceof Date) {
                            dateStr = apt.date.toLocaleDateString('en-GB');
                        } else {
                            dateStr = apt.date;
                        }
                    }
                    
                    row.innerHTML = `
                        <td><strong>${apt.patientName || 'Unknown'}</strong></td>
                        <td>${apt.doctorName || 'Unknown'}</td>
                        <td>${dateStr}</td>
                        <td>${apt.time || '10:00 AM'}</td>
                        <td><span class="status ${(apt.status || 'pending').toLowerCase()}">${apt.status || 'Pending'}</span></td>
                        <td><strong>‚Çπ${apt.fee?.toLocaleString() || '0'}</strong></td>
                    `;
                    appointmentsBody.appendChild(row);
                });
            }

        } catch (error) {
            console.error("‚ùå Error loading data:", error);
            
            // Show error but keep existing values if any
            if (document.getElementById('totalPatients').textContent === '0') {
                document.getElementById('totalPatients').textContent = '‚ö†Ô∏è';
            }
            if (document.getElementById('totalDoctors').textContent === '0') {
                document.getElementById('totalDoctors').textContent = '‚ö†Ô∏è';
            }
            if (document.getElementById('totalAppointments').textContent === '0') {
                document.getElementById('totalAppointments').textContent = '‚ö†Ô∏è';
            }
            
            document.getElementById('appointmentsBody').innerHTML = 
                `<tr><td colspan="6" class="error">‚ùå Error loading appointments. Please check your connection.</td></tr>`;
            
            showNotification("Error loading data: " + error.message, "error");
        }
    }

    // ==================== ADD SAMPLE DATA ====================
    async function addSampleData() {
        try {
            showNotification("Adding sample data...", "success");
            
            const patients = [
                { name: 'Ravi Kumar', age: 35, gender: 'Male', phone: '9876543210', email: 'ravi.k@email.com', bloodGroup: 'O+', address: 'Delhi', status: 'Active', registeredDate: new Date().toISOString() },
                { name: 'Meena Sharma', age: 28, gender: 'Female', phone: '9876543211', email: 'meena.s@email.com', bloodGroup: 'B+', address: 'Mumbai', status: 'Active', registeredDate: new Date().toISOString() },
                { name: 'Suresh Patel', age: 42, gender: 'Male', phone: '9876543212', email: 'suresh.p@email.com', bloodGroup: 'A+', address: 'Bangalore', status: 'Active', registeredDate: new Date().toISOString() }
            ];

            for (const patient of patients) {
                await db.collection('patients').add(patient);
            }

            const doctors = [
                { name: 'Dr. Arjun Mehta', specialization: 'Cardiology', experience: 12, phone: '9876543220', email: 'dr.arjun@hospital.com', qualification: 'MD, DM', fee: 1500 },
                { name: 'Dr. Priya Kapoor', specialization: 'Pediatrics', experience: 8, phone: '9876543221', email: 'dr.priya@hospital.com', qualification: 'MD', fee: 1200 },
                { name: 'Dr. Raj Verma', specialization: 'Orthopedics', experience: 15, phone: '9876543222', email: 'dr.raj@hospital.com', qualification: 'MS, MCh', fee: 1800 }
            ];

            for (const doctor of doctors) {
                await db.collection('doctors').add(doctor);
            }

            const today = new Date();
            
            const appointments = [
                {
                    patientName: 'Ravi Kumar',
                    doctorName: 'Dr. Arjun Mehta',
                    date: today,
                    time: '10:30 AM',
                    status: 'Completed',
                    fee: 1500
                },
                {
                    patientName: 'Meena Sharma',
                    doctorName: 'Dr. Priya Kapoor',
                    date: today,
                    time: '11:45 AM',
                    status: 'Pending',
                    fee: 1200
                },
                {
                    patientName: 'Suresh Patel',
                    doctorName: 'Dr. Raj Verma',
                    date: today,
                    time: '02:00 PM',
                    status: 'Scheduled',
                    fee: 1800
                }
            ];

            for (const apt of appointments) {
                await db.collection('appointments').add(apt);
            }

            showNotification("‚úÖ Sample data added successfully!");
            await loadDashboardData();

        } catch (error) {
            console.error("‚ùå Error adding sample data:", error);
            showNotification("Error adding data: " + error.message, "error");
        }
    }

    // ==================== AUTO-LOGIN ANONYMOUSLY ====================
    function autoLogin() {
        auth.signInAnonymously()
            .then(() => {
                console.log("‚úÖ Signed in anonymously");
            })
            .catch(error => {
                console.log("Anonymous sign-in error:", error);
                // Continue anyway - might be using public rules
            });
    }

    // ==================== MENU INTERACTIONS ====================
    document.querySelectorAll('.menu-item:not(.logout)').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('.menu-item').forEach(mi => {
                mi.classList.remove('active');
            });
            this.classList.add('active');
            
            // Don't show navigation notification for items with direct links
            if (!this.hasAttribute('onclick')) {
                const section = this.getAttribute('data-section');
                if (section) {
                    showNotification(`Navigating to ${section} section`, "success");
                }
            }
        });
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to logout?')) {
            auth.signOut().then(() => {
                showNotification("Logged out successfully");
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
            }).catch(error => {
                showNotification("Error logging out: " + error.message, "error");
            });
        }
    });

    // Add Sample Data Button
    document.getElementById('addSampleDataBtn').addEventListener('click', async function() {
        if (confirm('This will add sample patients, doctors, and appointments. Continue?')) {
            await addSampleData();
        }
    });

    // ==================== INITIAL LOAD ====================
    document.addEventListener('DOMContentLoaded', () => {
        // Try anonymous login (won't break if it fails)
        autoLogin();
        
        // Load dashboard data
        loadDashboardData();
        
        // Set up real-time listeners for auto-update
        if (db) {
            db.collection('patients').onSnapshot((snapshot) => {
                console.log("Patients collection changed, updating count...");
                document.getElementById('totalPatients').textContent = snapshot.size;
            }, (error) => {
                console.log("Patient listener error (ignored):", error);
            });
            
            // Add real-time listener for doctors collection
            db.collection('doctors').onSnapshot((snapshot) => {
                console.log("Doctors collection changed, updating count...");
                document.getElementById('totalDoctors').textContent = snapshot.size;
            }, (error) => {
                console.log("Doctor listener error (ignored):", error);
            });
            
            // Add real-time listener for appointments collection
            db.collection('appointments').onSnapshot((snapshot) => {
                console.log("Appointments collection changed, updating count...");
                document.getElementById('totalAppointments').textContent = snapshot.size;
                
                // Also update revenue when appointments change
                let totalRevenue = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'Completed' && data.fee) {
                        totalRevenue += data.fee;
                    }
                });
                document.getElementById('totalRevenue').textContent = `‚Çπ${totalRevenue.toLocaleString()}`;
            }, (error) => {
                console.log("Appointment listener error (ignored):", error);
            });
        }
    });
</script>